name: deploy-on-tag

on:
    push:
        tags:
            - "v*.*.*"
            - "v*.*"

permissions:
    id-token: write # OIDC
    contents: read

jobs:
    build-push-deploy:
        runs-on: ubuntu-latest
        env:
            AWS_REGION: ${{ vars.AWS_REGION }}
            AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
            EKS_CLUSTER_NAME: ${{ vars.EKS_CLUSTER_NAME }}
            ECR_REPO: ${{ vars.ECR_REPO }}
            IMAGE_TAG: ${{ github.sha }}
            ECR_URI: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Ensure ECR repo exists
              run: |
                  aws ecr describe-repositories --repository-names "${ECR_REPO}" >/dev/null 2>&1 || \
                    aws ecr create-repository --repository-name "${ECR_REPO}" --image-scanning-configuration scanOnPush=true >/dev/null

            - name: Login to ECR
              run: |
                  aws ecr get-login-password --region "${AWS_REGION}" \
                    | docker login --username AWS --password-stdin "${ECR_URI}"

            - name: Build image
              run: |
                  docker build -t "${ECR_REPO}:${IMAGE_TAG}" .

            - name: Tag & push image (with basic retry)
              run: |
                  set -e
                  docker tag "${ECR_REPO}:${IMAGE_TAG}" "${ECR_URI}/${ECR_REPO}:${IMAGE_TAG}"
                  for i in 1 2 3; do
                    docker push "${ECR_URI}/${ECR_REPO}:${IMAGE_TAG}" && break || { echo "push retry $i"; sleep 5; }
                  done

            - name: Install kubectl
              uses: azure/setup-kubectl@v4

            - name: Install Helm
              uses: azure/setup-helm@v4

            - name: Update kubeconfig
              if: ${{ env.EKS_CLUSTER_NAME != '' }}
              run: |
                  aws eks update-kubeconfig --name "${EKS_CLUSTER_NAME}" --region "${AWS_REGION}"

            - name: Helm deploy (ml-service)
              if: ${{ env.EKS_CLUSTER_NAME != '' }}
              run: |
                  helm upgrade --install ml-svc ./helm/ml-service \
                    --set image.repository="${ECR_URI}/${ECR_REPO}" \
                    --set image.tag="${IMAGE_TAG}"
