name: oidc-smoke

on:
    workflow_dispatch: {} # run this manually from the Actions tab

permissions:
    id-token: write # REQUIRED for OIDC
    contents: read

jobs:
    assume-and-check:
        runs-on: ubuntu-latest
        env:
            AWS_REGION: ${{ vars.AWS_REGION }}
            AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
            ECR_REPO: ${{ vars.ECR_REPO }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Show caller identity
              run: |
                  aws sts get-caller-identity

            - name: Ensure ECR repo exists and login
              run: |
                  set -e
                  aws ecr describe-repositories --repository-names "${ECR_REPO}" >/dev/null 2>&1 || \
                    aws ecr create-repository --repository-name "${ECR_REPO}" >/dev/null
                  aws ecr get-login-password --region "${AWS_REGION}" \
                    | docker login --username AWS --password-stdin \
                      "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

            - name: List ECR repos (sanity)
              run: |
                  aws ecr describe-repositories --query 'repositories[].repositoryName'
